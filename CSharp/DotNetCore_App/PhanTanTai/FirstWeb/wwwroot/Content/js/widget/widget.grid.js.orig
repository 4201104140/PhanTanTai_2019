$.widget('widget.grid', $.widget.base, {
    options: {
        name: null
    },
    _create: function () {
        var self = this;
        this._setDefaultValue();

        if (this.options.paginateOptions) {
            var pagiName = 'pagination' + '_' + this.options.name + this.options.paginateOptions.name || '';
            this.options.toolbar.items.push({ type: 'spacer' });
            this.options.toolbar.items.push({
                type: 'html',
                id: pagiName + '_id',
                html: '<div class="pagination pull-right" style="width: 330px; margin-right:-5px;"><ul id="' + pagiName + '" class="pull-right "></ul></div>'
            });
        };
        var recidArr = this.options.recid;
        if ($.isArray(recidArr)) {
            self.addRecid(this.options.data, recidArr);
            this.options.recid = null;
        }

        this._handleRenderType(this.options.columns);

        //onCellClick
        if (self.options.onCellClick) {
            //backup onClick
            var onClickBackup = this.options.onClick;
            this.options.onClick = function (e) {
<<<<<<< Updated upstream
                if (e.column != null) {
=======
                debugger;
                if (e.column) {
>>>>>>> Stashed changes
                    $.extend(e, {
                        columnOptions: self.options.columns[e.column],
                        srcElement: e.originalEvent.srcElement,
                        srcElementAttributes: self._readAllAttribute(e.originalEvent.srcElement),
                        record: this.get(e.recid)
                    });

                    self.options.onCellClick[e.columnOptions.field] && self.options.onCellClick[e.columnOptions.field].call(self, e);
                    //goi ham onClick da backup
                    onClickBackup && onClickBackup.call(self, e);
                }
            }
        }
        var grid = this.element.w2grid(this.options);
        this.options.data && grid.add(this.options.data);

        if ($.isArray(recidArr)) {
            //proxy 
            var gridAdd = grid.add.bind(grid);
            $.extend(grid, {
                add: function (records) {
                    self.addRecid(records, recidArr);
                    gridAdd(records);
                }
            });
        }

        if (this.options.paginateOptions) {
            var pagi = this.element.find('#' + pagiName).pagination(this.options.paginateOptions);
            var pagiData = pagi.data("widget-pagination").options.__data;
            $.extend(grid, { pagination: pagiData });
        }

        grid.getLastRecord = function () {
            if (grid.records == null || grid.records.length == 0) {
                return null;
            }
            else if (grid.records.length == 1) {
                return grid.records[0];
            }
            else {
                var records = $.extend([], grid.records)
                records.sort(function (a, b) { return a.recid - b.recid });
                return records[records.length - 1];
            }
        }

        // tạo biến tạm để thực hiện get-set trên biến đó
        grid.backupColumns = grid.columns;
        Object.defineProperty(grid, 'columns', {
            set: function (x) {
                self._handleRenderType(x);
                grid.backupColumns = x;
            },
            get: function () {
                return this.backupColumns;
            },
        });


        this.options.onRenderCompleted && this.options.onRenderCompleted(grid);

        this._super();
        this._saveData(grid);
    },
    _readAllAttribute: function ($el) {
        var attrObject = {};
        $.each($el.attributes, function (k, v) {
            attrObject[v.name] = v.value;
        });
        return attrObject;
    },
    _setDefaultValue: function () {
        var self = this;

        //resizable = false
        $.each(this.options.columns, function (k, col) {
            if (!col.resizable) {
                col.resizable = false;
            }
        });
    },
    _handleRenderType: function (columns) {
        var self = this;
        $.each(columns, function (k, col) {
            if (col.RenderType != null) {
                col.options = col.options || {};
                col.render = self._getRenderFunction(col);
            }
        });
    },

    _getRenderFunction: function (col) {
        var self = this;
        return widget.grid.rendertype[col.RenderType].bind(col);
    },
    addRecid: function (records, recidArr) {
        if (!$.isArray(records)) {
            records = [records];
        }

        $.each(records || [], function (keyData, valData) {
            var recid = [];
            $.each(recidArr || [], function (key, val) {
                recid.push(valData[val]);
            });
            $.extend(valData, { recid: recid.join('_') });
        });
    }
});